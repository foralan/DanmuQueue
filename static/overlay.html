<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>排队姬 - Overlay</title>
  <link rel="stylesheet" href="/static/default.css" />
  <link rel="stylesheet" href="/static/custom.css" />
</head>
<body>
  <div class="container">
    <div class="title" id="title">排队</div>
    <div class="sectionTitle" id="currentTitle">当前</div>
    <div class="queue" id="current"></div>
    <div class="sectionTitle" id="queueTitle">队列</div>
    <div class="queue" id="queue"></div>
    <div class="hint" id="hint"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function render(s) {
      $("title").textContent = s.config?.ui?.overlay_title ?? "排队";
      $("currentTitle").textContent = s.config?.ui?.current_title ?? "当前";
      $("queueTitle").textContent = s.config?.ui?.queue_title ?? "队列";
      const showMark = !!s.config?.ui?.overlay_show_mark;
      const emptyText = s.config?.ui?.empty_text ?? "当前无人排队";

      const q = s.queue ?? { items: [], max_queue: 0, total: 0, is_full: false };
      const items = q.items ?? [];

      const curRoot = $("current");
      const queueRoot = $("queue");
      curRoot.innerHTML = "";
      queueRoot.innerHTML = "";

      if (s.runtime?.status !== "running") {
        $("hint").textContent = "未启动：请打开 /admin 点击“启动”。";
        return;
      }

      $("hint").textContent = "";

      // Current: index 0 (always render a row)
      {
        const it = items[0] ?? null;
        const div = document.createElement("div");
        const isMarked = !!(it && it.marked) && showMark;
        div.className = "item" + (isMarked ? " marked" : "") + (!it ? " empty" : "");
        // Hard guarantee: keep index/username/mark on the same row even if CSS is missing/overridden.
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.gap = "4px";
        div.style.flexWrap = "nowrap";

        const index = document.createElement("span");
        index.className = "index";
        // Never show digit "0" (keep alignment with an empty placeholder).
        index.textContent = "";

        const name = document.createElement("span");
        name.className = "name";
        name.textContent = it ? (it.uname ?? it.user_key ?? "-") : emptyText;

        div.appendChild(index);
        div.appendChild(name);

        // Mark is optional via config.
        if (isMarked) {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = "标记";
          div.appendChild(badge);
        }

        curRoot.appendChild(div);
      }

      // Queue: index 1..n
      items.slice(1).forEach((it, idx0) => {
        const idx = idx0 + 1;
        const div = document.createElement("div");
        const isMarked = !!it.marked && showMark;
        div.className = "item" + (isMarked ? " marked" : "");
        // Hard guarantee: keep index/username/mark on the same row even if CSS is missing/overridden.
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.gap = "4px";
        div.style.flexWrap = "nowrap";

        const index = document.createElement("span");
        index.className = "index";
        index.textContent = String(idx);

        const name = document.createElement("span");
        name.className = "name";
        name.textContent = it.uname ?? it.user_key ?? "-";

        div.appendChild(index);
        div.appendChild(name);

        // Mark is optional via config.
        if (isMarked) {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = "标记";
          div.appendChild(badge);
        }

        queueRoot.appendChild(div);
      });

      if (q.is_full) {
        const full = document.createElement("div");
        full.className = "item full";
        const index = document.createElement("div");
        index.className = "index";
        index.textContent = "";
        const text = document.createElement("div");
        text.className = "name";
        text.textContent = "排队已满";
        full.appendChild(index);
        full.appendChild(text);
        queueRoot.appendChild(full);
      }
    }

    function connectWs() {
      const wsProto = location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${wsProto}://${location.host}/ws`);
      ws.onmessage = (e) => {
        try { render(JSON.parse(e.data)); } catch {}
      };
      ws.onclose = () => setTimeout(connectWs, 1000);
    }

    (async () => {
      const s = await (await fetch("/api/state")).json();
      render(s);
      connectWs();
      // Fallback polling (in case ws is unavailable)
      setInterval(async () => {
        try {
          const s2 = await (await fetch("/api/state")).json();
          render(s2);
        } catch {}
      }, 2000);
    })();
  </script>
</body>
</html>


